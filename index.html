<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <style>
    @import url('https://fonts.googleapis.com/css?family=Montserrat:400,600');

    html, body, input, p {
      font-family: 'Montserrat', 'Helvetica Neue', arial;
    }

    #r h2 {
      font-size: 1.5em;
      font-weight: bold;
      line-height: 3em;
      text-align: center;
    }

    #r h3 {
      color: #4a5568;
      text-align: center;
      line-height: 2.5em;
      font-style: italic;
      margin-bottom: 0.5em;
    }

    #r p {
      margin-bottom: 0.5em;
    }

    #r .verse-num {
      font-size: 0.5em;
      font-weight: normal;
      vertical-align: super;
    }

    #r .fn {
      display: none;
    }

    #r .audio, #r .footnotes, #r .chapter-num {
      display: none;
    }

    #r p:last-child {
      display: none;
    }

    input:focus {
      outline-width: 0;
    }
    </style>
  </head>
  <body class="font-mono text-gray-900">
    <form class="fixed w-full h-12 top-0 bg-gray-200 shadow flex
                 justify-between p-2 items-center z-10">
      <a
        class="text-xs text-gray-600 underline cursor-pointer"
        href="https://github.com/staab/esv"
        target="_blank">
        About
      </a>
      <div class="flex justify-center items-center">
        <img src="/search.svg" class="h-4 -mr-6 z-10 opacity-50" />
        <input name="q" class="rounded p-2 pl-8 h-8" type="text" />
      </div>
    </form>
    <ul
      id="suggestions"
      class="hidden fixed right-0 -mr-1 pt-16 bg-white border
             border-gray-200 w-64 max-h-full shadow">
    </ul>
    <div class="p-2 pt-16">
      <p id="copyright" class="-mt-5 text-gray-400 text-xs text-center hidden">
        Copyright
        <a
          class="underline cursor-pointer"
          href="https://www.esv.org"
          target="_blank">
          esv.org
        </a>
      </p>
      <p id="r" class="text-gray-900 text-sm"></p>
    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.4.5/fuse.min.js"></script>
    <script>
      const $ = document.querySelector.bind(document)
      const $q = $('[name="q"]')
      const $r = $('#r')
      const $copyright = $('#copyright')
      const $suggestions = $('#suggestions')
      const books = {
        'Genesis':	50, 'Exodus':	40, 'Leviticus':	27, 'Numbers':	36,
        'Deuteronomy':	34, 'Joshua':	24, 'Judges':	21, 'Ruth':	4,
        '1 Samuel':	31, '2 Samuel':	24, '1 Kings':	22, '2 Kings':	25,
        '1 Chronicles':	29, '2 Chronicles':	36, 'Ezra':	10, 'Nehemiah':	13,
        'Esther':	10, 'Job':	42, 'Psalms':	150, 'Proverbs':	31,
        'Ecclesiastes':	12, 'Song of Solomon':	8, 'Isaiah':	66, 'Jeremiah':	52,
        'Lamentations':	5, 'Ezekiel':	48, 'Daniel':	12, 'Hosea':	14,
        'Joel':	3, 'Amos':	9, 'Obadiah':	1, 'Jonah':	4, 'Micah':	7,
        'Nahum':	3, 'Habakkuk':	3, 'Zephaniah':	3, 'Haggai':	2,
        'Zechariah':	14, 'Malachi':	4, 'Matthew':	28, 'Mark':	16,
        'Luke':	24, 'John':	21, 'Acts':	28, 'Romans':	16, '1 Corinthians':	16,
        '2 Corinthians':	13, 'Galatians':	6, 'Ephesians':	6, 'Philippians':	4,
        'Colossians':	4, '1 Thessalonians':	5, '2 Thessalonians':	3,
        '1 Timothy':	6, '2 Timothy':	4, 'Titus':	3, 'Philemon':	1,
        'Hebrews':	13, 'James':	5, '1 Peter':	5, '2 Peter':	3, '1 John':	5,
        '2 John':	1, '3 John':	1, 'Jude':	1, 'Revelation':	22,
      }

      const fuse = new Fuse(
        Object.keys(books).map(book => ({book})),
        {shouldSort: true, keys: ['book']}
      )

      search('John 1')

      $('form').addEventListener('submit', evt => {
        evt.preventDefault()

        search($q.value)
      })

      window.addEventListener('keyup', evt => {
        if (evt.key === 'Escape') {
          $suggestions.classList.add('hidden')
        }
      })

      $q.addEventListener('mousedown', evt => {
        if (document.activeElement !== $q) {
          window.requestIdleCallback(() => evt.target.select())
        }
      })

      $q.addEventListener('blur', evt => {
        window.requestIdleCallback(() => $suggestions.classList.add('hidden'))
      })

      $q.addEventListener('input', evt => {
        $suggestions.innerHTML = ''

        const term = evt.target.value

        // If the search term already has a chapter/verse in it, don't
        // show suggestions
        const results = term.match(/[\w ]+[0-9]/g)
          ? []
          : fuse.search(term).filter(({book}) =>
            // Skip matches that are just a prefix of the search term
            term.toLowerCase().indexOf(book.toLowerCase()) !== 0
          )

        results.forEach(({book}) => {
          const $li = document.createElement('li')

          $li.innerText = book
          $li.classList.add('p-2')
          $li.classList.add('cursor-pointer')
          $li.classList.add('hover:bg-gray-100')
          $li.addEventListener('click', evt => {
            $q.value = book + ' '
            $q.focus()

            search($q.value, false)

            $suggestions.classList.add('hidden')
          })

          $suggestions.appendChild($li)
        })

        if (results.length > 0) {
          $suggestions.classList.remove('hidden')
        } else {
          $suggestions.classList.add('hidden')
        }
      })

      async function search(q, setCanonical = true) {
        const url = `/api/passage/html/?q=${q}`
        const {canonical, passages} = await fetch(url).then(r => r.json())

        if (passages.length === 0) {
          $r.innerHTML = "No results found!"
        } else {
          if (setCanonical) {
            $q.value = canonical
          }

          $r.innerHTML = passages[0]

           // Add the copyright
          $h2 = $r.querySelector('h2')
          $cp = $copyright.cloneNode(true)
          $cp.classList.remove('hidden')
          $h2.parentNode.insertBefore($cp, $h2.nextSibling)
        }
      }
    </script>
  </body>
</html>
